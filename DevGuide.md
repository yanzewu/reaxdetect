
# Development Guide of ReaxDetect

## Application Hierarchy

The main procedure of ReaxDetect is

1. Parse options (both command line and configuration file);
2. Read trajectory and parse molecule connectivities;
3. Generate molecule symbols and reactions;
4. Output;

Procedure 2 and 3 is done circularly, i.e. once a frame is read, it is sent to molecule and reaction analyzer.

`ReaxDetect` class ([reaxdetect.h](reaxdetect/reaxdetect.h)) serves as the top entry of the program. It controls option parsing (`read_opt()`, `translate_opt()`, `read_boc()`) and data flow (`exec()`).

`TrajReader` class ([trajectory.h](reaxdetect/trajectory.h)) is abstract; Only 3 methods are required from it:
- `Open()` opens a file;
- `ReadTrjHead()` reads the metadata which may be present in the trajectory header;
- `ReadTrjFrame()` reads a single frame from the trajectory.

The metadata of trajectory is stored in `Simulation` ([simulation.h](reaxdetect/simulation.h)) and frame data is stored in `TrajFrame` ([trajectory.h](reaxdetect/trajectory.h)). `TrajFrame` consists of atom ids and discrete bond order data. Therefore the bond order discretization should be completed in `TrajReader`.

A reaxff trajectory reader is provided as `ReaxTrajReader` and enabled as default, which reads and analyzes the data generated by LAMMPS command `pair_style reax/c`. It can also do simple bond order statistics.

`ReaxReader` class ([reaxreader.h](reaxdetect/reaxreader.h)) analyzes the connectivity data and generate intermediate molecule representation (SMILES class) and reaction statistics. The results are saved to a vector of `FrameStat`, which contains molecule and reaction (both forward and backward) frequencies. The algorithm is somewhat complicated and is introduced in a separated section.

`ReaxAnalyzer` class ([analyzer.h](reaxdetect/analyzer.h)) used to perform the post-analysis but has been largely simplified. The major functions have been moved to separated projects.

`ReaxDataWriter`class ([datawriter.h](reaxdetect/datawriter.h)) is responsible for output.


## Configurations

The basic configuration is already mentioned in README. Frames before RecognizeBegin (-b), after RecognizeLimit (-m) and between RecognizeStep (-s) will be discarded directly after being read by `TrajReader`.

Two options from `ReaxTrajReader` for customize bond order discretization:

- `BondOrderCutoffDefault`: Specifies the default bond order cutoff;
- `BondOrderCutoff`: Specifies the file that describes element-pair-wise bond order cutoff;

For example, if `BondOrderCutoffDefault="0.5,0.5,0.6"`, then a bond with order less than 0.5 will be discarded; A bond with order between 0.5~0.6 will be treated as a single bond.

If `BondOrderCutoffDefault="0.4,0.5,0.6"`, a bond with order between 0.4~0.5 will be treated as "semi-bond", with symbol "~".

The format of BondOrderCutoff can be referenced in [example](example/boc.txt).

At most 4 entries are allowed in each bond order specification, corresponding to bond order 0.5, 1, 2, 3.

If `CountBondOrder` is set, `ReaxTrajReader` will also generate a file listing all the bond order data it met, categorized by element pair in rows. This can be a huge amount of data, so it's better to limit the number of frames before running (for example, set larger step or earlier termination).

## Algorithm of Molecule Identification

Molecules are identified by depth-first search (DFS). The reactions are identified by comparing connectivity in adjacent frames using DFS:

1. For one molecule in the source frame, find the destination molecule of all atoms in its next frame;
2. Add the destination molecule of each atom into the product list;
3. For all atoms in product molecules, find the source molecule in source frame;
4. Add the source molecule of each atom into the reactant list;
5. Repeat 1-4, until no more new molecule is added;
6. If reactant(s) = product(s), the reaction is discarded. Otherwise a new reaction is found.

The reaction representation will be canonicalized to remove duplicates and identify reversed reactions. 

To remove short-lived reactions or "vibrations", ReaxDetect keeps the newly-identified reaction for next several steps. If in the following n frames an _exact_ reverse reaction is found (which means the reaction has not only the reversed chemical formula, but also the reverse indices of same atoms), then the forward reaction is discarded.

To use this feature, `FrameBufferSize` should be set to n+2 with n >= 1, since just identifying reactions need 2 frames. If n=0 then reverse reaction will not be checked.

Note the analyzer may complain "Inflow calc error" because some reactions are discarded and total species flow does not match. This is normal and will not affect the result statistically if the parameters are set properly.

A reaction is stored as struct of two vectors {(r1,r2,r3,...) (p1,p2,p3,...)}, where r's and p's are indices of reactant and product molecules (the frame-wise indices before validity and reversibility check, and global indices after that).


### SMILES

Molecules recognized are translated into canonical SMILES classes ([smiles.h](reaxdetect/smiles/smiles.h)) for comparison and output.

Since the SMILES translation and canonicalization is slow, what actually happens is that molecules are first translated to `MatMolecule` as an intermediate representation. Same molecules may have different `MatMolecule` but different `MatMolecule`'s always stand for different molecules. Therefore, molecules with same intermediate representation are grouped first, and the SMILES translation only need to be done once per group.

